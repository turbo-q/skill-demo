<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>漏洞扫描 Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: {} } }
  </script>
  <style>
    .msg-content pre { @apply whitespace-pre-wrap break-words rounded bg-black/20 p-2 text-sm; }
    .msg-content p { @apply my-1; }
    .msg-content code { @apply rounded bg-black/20 px-1 text-sm; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col">
  <header class="border-b border-slate-700 px-4 py-3 flex items-center gap-3 shrink-0">
    <span class="font-semibold text-lg">漏洞扫描 Agent</span>
    <span class="text-slate-400 text-sm">Skill · 工具 · 会话</span>
  </header>

  <div class="flex flex-1 min-h-0">
    <!-- 侧栏：用户 + 会话列表 -->
    <aside class="w-64 border-r border-slate-700 flex flex-col shrink-0 bg-slate-800/50">
      <div class="p-3 border-b border-slate-700">
        <label class="block text-xs text-slate-400 mb-1">用户 ID</label>
        <input type="text" id="userId" value="default" placeholder="default"
          class="w-full rounded-lg bg-slate-700 border border-slate-600 px-3 py-2 text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent" />
      </div>
      <div class="p-3 border-b border-slate-700">
        <div class="text-xs text-slate-400 font-medium mb-2">模型配置</div>
        <table class="w-full text-sm">
          <tr>
            <td class="text-slate-400 py-1 pr-2 align-top w-20">模型</td>
            <td class="py-1">
              <select id="configModel" class="w-full rounded bg-slate-700 border border-slate-600 px-2 py-1.5 text-sm focus:ring-1 focus:ring-cyan-500">
                <option value="">请先获取模型列表</option>
              </select>
            </td>
          </tr>
          <tr>
            <td></td>
            <td class="py-1">
              <button type="button" id="fetchModelsBtn" class="text-xs rounded bg-slate-600 hover:bg-slate-500 px-2 py-1">
                获取模型列表
              </button>
            </td>
          </tr>
          <tr>
            <td class="text-slate-400 py-1 pr-2 align-top">Base URL</td>
            <td class="py-1">
              <input type="text" id="configBaseUrl" placeholder="可选，如 https://api.openai.com/v1" autocomplete="off"
                class="w-full rounded bg-slate-700 border border-slate-600 px-2 py-1.5 text-sm focus:ring-1 focus:ring-cyan-500" />
            </td>
          </tr>
          <tr>
            <td class="text-slate-400 py-1 pr-2 align-top">API Key</td>
            <td class="py-1">
              <input type="password" id="configApiKey" placeholder="可选，不填用环境变量" autocomplete="off"
                class="w-full rounded bg-slate-700 border border-slate-600 px-2 py-1.5 text-sm focus:ring-1 focus:ring-cyan-500" />
            </td>
          </tr>
        </table>
        <button type="button" id="saveConfig" class="mt-2 w-full rounded-lg bg-slate-600 hover:bg-slate-500 px-3 py-2 text-sm">
          保存配置
        </button>
      </div>
      <div class="p-3 border-b border-slate-700">
        <button type="button" id="newChat" class="w-full rounded-lg bg-cyan-600 hover:bg-cyan-500 px-3 py-2 text-sm font-medium">
          新会话
        </button>
        <button type="button" id="refreshSessions" class="w-full mt-2 rounded-lg bg-slate-600 hover:bg-slate-500 px-3 py-2 text-sm">
          刷新会话列表
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-3">
        <div class="text-xs text-slate-400 mb-2">会话列表</div>
        <ul id="sessionList" class="space-y-1"></ul>
        <p id="sessionListEmpty" class="text-slate-500 text-sm hidden">暂无会话，发送消息将自动创建</p>
      </div>
    </aside>

    <!-- 主区：当前会话 + 消息 + 输入 -->
    <main class="flex-1 flex flex-col min-w-0">
      <div class="border-b border-slate-700 px-4 py-2 flex items-center gap-2 shrink-0">
        <span class="text-slate-400 text-sm">当前会话：</span>
        <code id="currentSessionId" class="text-cyan-400 text-sm truncate flex-1">未选择</code>
      </div>

      <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

      <div class="border-t border-slate-700 p-4 shrink-0">
        <form id="form" class="flex gap-2">
          <input type="text" id="input" placeholder="输入消息，例如：对 http://example.com 做基础 Web 扫描…" autocomplete="off"
            class="flex-1 rounded-lg bg-slate-700 border border-slate-600 px-4 py-3 text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent" />
          <button type="submit" id="send" class="rounded-lg bg-cyan-600 hover:bg-cyan-500 px-5 py-3 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">
            发送
          </button>
        </form>
      </div>
    </main>
  </div>

  <script>
    const API = '';
    const messagesEl = document.getElementById('messages');
    const sessionListEl = document.getElementById('sessionList');
    const sessionListEmptyEl = document.getElementById('sessionListEmpty');
    const currentSessionIdEl = document.getElementById('currentSessionId');
    const userIdEl = document.getElementById('userId');
    const configModelEl = document.getElementById('configModel');
    const configBaseUrlEl = document.getElementById('configBaseUrl');
    const configApiKeyEl = document.getElementById('configApiKey');
    const saveConfigBtn = document.getElementById('saveConfig');
    const fetchModelsBtn = document.getElementById('fetchModelsBtn');
    const inputEl = document.getElementById('input');
    const form = document.getElementById('form');
    const sendBtn = document.getElementById('send');
    const newChatBtn = document.getElementById('newChat');
    const refreshSessionsBtn = document.getElementById('refreshSessions');

    let currentSessionId = '';

    function escapeHtml(s) {
      const p = document.createElement('p');
      p.textContent = s;
      return p.innerHTML;
    }

    function addMessage(role, content, toolCalls) {
      const isUser = role === 'user';
      const div = document.createElement('div');
      div.className = 'flex ' + (isUser ? 'justify-end' : 'justify-start');
      const bubble = document.createElement('div');
      bubble.className = 'max-w-[85%] rounded-xl px-4 py-2.5 ' + (isUser ? 'bg-cyan-600/80' : 'bg-slate-700');
      const roleEl = document.createElement('div');
      roleEl.className = 'text-xs opacity-75 mb-1';
      roleEl.textContent = isUser ? '我' : 'Agent';
      const contentEl = document.createElement('div');
      contentEl.className = 'msg-content text-sm whitespace-pre-wrap break-words';
      contentEl.textContent = content;
      bubble.appendChild(roleEl);
      bubble.appendChild(contentEl);
      if (!isUser && toolCalls && toolCalls.length > 0) {
        const toolsWrap = document.createElement('div');
        toolsWrap.className = 'mt-3 pt-3 border-t border-slate-600';
        const toolsTitle = document.createElement('div');
        toolsTitle.className = 'text-xs text-cyan-400 mb-2';
        toolsTitle.textContent = '调用的工具 (' + toolCalls.length + ')';
        toolsWrap.appendChild(toolsTitle);
        toolCalls.forEach(function (tc, i) {
          const block = document.createElement('div');
          block.className = 'text-xs rounded bg-slate-800/80 p-2 mb-2';
          const nameLine = document.createElement('div');
          nameLine.className = 'font-medium text-cyan-300 mb-1';
          nameLine.textContent = (i + 1) + '. ' + (tc.tool || 'tool');
          block.appendChild(nameLine);
          if (tc.input && Object.keys(tc.input).length) {
            const inputLine = document.createElement('div');
            inputLine.className = 'text-slate-400 mb-1';
            inputLine.textContent = '入参: ' + JSON.stringify(tc.input);
            block.appendChild(inputLine);
          }
          if (tc.output != null && tc.output !== '') {
            const outLine = document.createElement('div');
            outLine.className = 'text-slate-300 whitespace-pre-wrap break-words';
            const out = String(tc.output);
            outLine.textContent = '结果: ' + (out.length > 500 ? out.slice(0, 500) + '…' : out);
            block.appendChild(outLine);
          }
          toolsWrap.appendChild(block);
        });
        bubble.appendChild(toolsWrap);
      }
      div.appendChild(bubble);
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setCurrentSession(sid) {
      currentSessionId = sid || '';
      currentSessionIdEl.textContent = sid ? sid.slice(0, 12) + (sid.length > 12 ? '…' : '') : '未选择';
      if (sid) inputEl.placeholder = '继续输入消息…';
      else inputEl.placeholder = '输入消息，发送将自动创建新会话';
    }

    async function loadSessions() {
      const uid = userIdEl.value.trim() || 'default';
      try {
        const r = await fetch(API + '/api/sessions?user_id=' + encodeURIComponent(uid));
        const data = await r.json();
        sessionListEl.innerHTML = '';
        if (!data.sessions || data.sessions.length === 0) {
          sessionListEmptyEl.classList.remove('hidden');
          return;
        }
        sessionListEmptyEl.classList.add('hidden');
        data.sessions.forEach(s => {
          const li = document.createElement('li');
          li.className = 'flex items-center gap-1 group';
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'flex-1 min-w-0 rounded-lg px-3 py-2 text-sm hover:bg-slate-700 truncate ' + (s.session_id === currentSessionId ? 'bg-slate-700 text-cyan-400' : '');
          a.textContent = (s.session_id.slice(0, 8) + '…') + ' (' + (s.message_count || 0) + ' 条)';
          a.addEventListener('click', e => { e.preventDefault(); selectSession(s.session_id); });
          li.appendChild(a);
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'shrink-0 rounded p-1.5 text-slate-400 hover:text-red-400 hover:bg-slate-700 opacity-0 group-hover:opacity-100 transition-opacity';
          delBtn.title = '删除会话';
          delBtn.innerHTML = '×';
          delBtn.style.fontSize = '1.25rem';
          delBtn.style.lineHeight = '1';
          delBtn.addEventListener('click', e => { e.preventDefault(); e.stopPropagation(); deleteSession(s.session_id); });
          li.appendChild(delBtn);
          sessionListEl.appendChild(li);
        });
      } catch (e) {
        sessionListEmptyEl.textContent = '加载失败';
        sessionListEmptyEl.classList.remove('hidden');
      }
    }

    async function selectSession(sid) {
      setCurrentSession(sid);
      const r = await fetch(API + '/api/history?session_id=' + encodeURIComponent(sid));
      const data = await r.json();
      messagesEl.innerHTML = '';
      (data.messages || []).forEach(m => addMessage(m.role, m.content, m.tool_calls));
      loadSessions();
    }

    newChatBtn.addEventListener('click', () => {
      setCurrentSession('');
      messagesEl.innerHTML = '';
      loadSessions();
    });

    refreshSessionsBtn.addEventListener('click', loadSessions);

    async function deleteSession(sid) {
      if (!confirm('确定删除该会话？将同时删除该会话下的全部消息，且不可恢复。')) return;
      const uid = userIdEl.value.trim() || 'default';
      try {
        const r = await fetch(API + '/api/sessions/' + encodeURIComponent(sid) + '?user_id=' + encodeURIComponent(uid), { method: 'DELETE' });
        if (!r.ok) {
          const data = await r.json().catch(() => ({}));
          throw new Error(data.detail || '删除失败');
        }
        if (currentSessionId === sid) {
          setCurrentSession('');
          messagesEl.innerHTML = '';
        }
        loadSessions();
      } catch (e) {
        alert('删除失败: ' + e.message);
      }
    }

    function fillModelSelect(models, selectedId) {
      configModelEl.innerHTML = '';
      if (!models || models.length === 0) {
        configModelEl.appendChild(new Option('无可用模型', ''));
        return;
      }
      const hasSelected = selectedId && models.includes(selectedId);
      models.forEach(id => {
        const opt = new Option(id, id);
        configModelEl.appendChild(opt);
      });
      configModelEl.value = hasSelected ? selectedId : models[0];
    }

    async function loadModels(useFormCredentials, selectedId) {
      const body = useFormCredentials ? {
        base_url: configBaseUrlEl.value.trim() || undefined,
        api_key: configApiKeyEl.value || undefined
      } : {};
      const method = useFormCredentials ? 'POST' : 'GET';
      const url = API + '/api/config/models';
      try {
        const r = method === 'POST'
          ? await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
          : await fetch(url);
        const data = await r.json();
        if (!r.ok) throw new Error(data.detail || '获取失败');
        fillModelSelect(data.models || [], selectedId != null ? selectedId : configModelEl.value);
      } catch (e) {
        configModelEl.innerHTML = '';
        configModelEl.appendChild(new Option('获取失败: ' + e.message, ''));
      }
    }

    async function loadConfig() {
      try {
        const r = await fetch(API + '/api/config');
        const c = await r.json();
        configBaseUrlEl.value = c.base_url || '';
        configApiKeyEl.value = '';
        configApiKeyEl.placeholder = c.api_key_set ? '已配置（输入新值可覆盖）' : '可选，不填用环境变量';
        if (c.api_key_set || (c.base_url && c.base_url.length > 0)) {
          fetchModelsBtn.textContent = '获取中…';
          fetchModelsBtn.disabled = true;
          await loadModels(false, c.model);
          fetchModelsBtn.disabled = false;
          fetchModelsBtn.textContent = '获取模型列表';
        } else {
          configModelEl.innerHTML = '';
          configModelEl.appendChild(new Option('请先填写 Base URL / API Key 后点击获取', ''));
        }
      } catch (e) {
        configApiKeyEl.placeholder = '加载失败';
      }
    }

    fetchModelsBtn.addEventListener('click', async () => {
      fetchModelsBtn.disabled = true;
      fetchModelsBtn.textContent = '获取中…';
      await loadModels(true);
      fetchModelsBtn.disabled = false;
      fetchModelsBtn.textContent = '获取模型列表';
    });

    saveConfigBtn.addEventListener('click', async () => {
      saveConfigBtn.disabled = true;
      const body = {
        model: configModelEl.value,
        base_url: configBaseUrlEl.value.trim() || ''
      };
      if (configApiKeyEl.value !== '') {
        body.api_key = configApiKeyEl.value;
      } else if (!configApiKeyEl.placeholder.startsWith('已配置')) {
        body.api_key = '';
      }
      try {
        const r = await fetch(API + '/api/config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        configApiKeyEl.value = '';
        configApiKeyEl.placeholder = data.api_key_set ? '已配置（输入新值可覆盖）' : '可选，不填用环境变量';
      } catch (e) {
        configApiKeyEl.placeholder = '保存失败';
      }
      saveConfigBtn.disabled = false;
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;
      addMessage('user', text);
      inputEl.value = '';
      sendBtn.disabled = true;
      try {
        const r = await fetch(API + '/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: currentSessionId || undefined,
            user_id: userIdEl.value.trim() || undefined,
            message: text
          })
        });
        const data = await r.json();
        if (data.session_id) {
          setCurrentSession(data.session_id);
          loadSessions();
        }
        addMessage('assistant', data.reply || '', data.tool_calls || []);
      } catch (err) {
        addMessage('assistant', '请求失败: ' + err.message);
      }
      sendBtn.disabled = false;
    });

    loadSessions();
    loadConfig();
  </script>
</body>
</html>
